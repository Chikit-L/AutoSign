import os
import requests
import hashlib
import base64

def download_and_save_file(local_path, remote_url):
    """ä¸‹è½½å¹¶ä¿å­˜æ–‡ä»¶"""
    try:
        # è·å–è¿œç¨‹æ–‡ä»¶å†…å®¹
        response = requests.get(remote_url)
        response.raise_for_status()
        remote_content = response.content
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(local_path), exist_ok=True)
        
        # ä¿å­˜æ–‡ä»¶
        with open(local_path, 'wb') as f:
            f.write(remote_content)
        print(f"âœ… æˆåŠŸä¸‹è½½æ–‡ä»¶åˆ°: {local_path}")
        return True
    except Exception as e:
        print(f"âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥ {local_path}: {str(e)}")
        return False

def check_and_update_file(local_path, remote_url):
    """æ£€æŸ¥å¹¶æ›´æ–°æ–‡ä»¶"""
    try:
        # è·å–è¿œç¨‹æ–‡ä»¶å†…å®¹
        response = requests.get(remote_url)
        response.raise_for_status()
        remote_content = response.content
        
        # å¦‚æœæœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥ä¸‹è½½
        if not os.path.exists(local_path):
            print(f"ğŸ“¥ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¼€å§‹ä¸‹è½½: {local_path}")
            return download_and_save_file(local_path, remote_url)
        
        # å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œæ¯”è¾ƒå†…å®¹
        with open(local_path, 'rb') as f:
            local_content = f.read()
            
        # ä½¿ç”¨MD5æ¯”è¾ƒæ–‡ä»¶å†…å®¹
        if hashlib.md5(local_content).hexdigest() == hashlib.md5(remote_content).hexdigest():
            print(f"âœ“ æ–‡ä»¶æ— éœ€æ›´æ–°: {local_path}")
            return False
        else:
            print(f"ğŸ”„ æ–‡ä»¶éœ€è¦æ›´æ–°: {local_path}")
            os.makedirs(os.path.dirname(local_path), exist_ok=True)
            with open(local_path, 'wb') as f:
                f.write(remote_content)
            print(f"âœ… æ–‡ä»¶å·²æ›´æ–°: {local_path}")
            return True
            
    except Exception as e:
        print(f"âŒ æ£€æŸ¥æ›´æ–°å¤±è´¥ {local_path}: {str(e)}")
        return False

def update_folder(local_path, remote_url):
    """æ›´æ–°æ•´ä¸ªæ–‡ä»¶å¤¹"""
    try:
        # è§£æ GitHub URL
        _, _, _, owner, repo, _, branch, *path = remote_url.split('/')
        path = '/'.join(path)
        
        # æ„å»º GitHub API URL
        api_url = f"https://api.github.com/repos/{owner}/{repo}/contents/{path}?ref={branch}"
        
        response = requests.get(api_url)
        response.raise_for_status()
        files = response.json()
        
        updated = False
        for file in files:
            if file['type'] == 'file':
                file_path = os.path.join(local_path, file['name'])
                if check_and_update_file(file_path, file['download_url']):
                    updated = True
            elif file['type'] == 'dir':
                subdir_path = os.path.join(local_path, file['name'])
                if update_folder(subdir_path, file['url']):
                    updated = True
        
        return updated
    except Exception as e:
        print(f"âŒ æ›´æ–°æ–‡ä»¶å¤¹å¤±è´¥ {local_path}: {str(e)}")
        return False

# è®¾ç½®è¾“å‡ºçŠ¶æ€ï¼ˆç”¨äºGitHub Actionsï¼‰
def set_output(name, value):
    if 'GITHUB_OUTPUT' in os.environ:
        with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
            print(f'{name}={value}', file=fh)

# ä¸»è¦æ‰§è¡Œé€»è¾‘
files_to_update = [
    {"local_path": "ablesci.py", "remote_url": "https://raw.githubusercontent.com/chenlunTian/ablesciSign/main/ablesci.py"},
    {"local_path": "Quark/Quark.py", "remote_url": "https://raw.githubusercontent.com/BNDou/Auto_Check_In/main/checkIn_Quark.py"},
    {"local_path": "Quark/utils", "remote_url": "https://github.com/BNDou/Auto_Check_In/tree/main/utils"},
    {"local_path": "wps.js", "remote_url": "https://raw.githubusercontent.com/wf021325/qx/refs/heads/main/task/wps.js"},
    {"local_path": "jingdong/jd_OnceApply.js", "remote_url": "https://raw.githubusercontent.com/6dylan6/jdpro/refs/heads/main/jd_OnceApply.js"},
    {"local_path": "jingdong/jd_AutoEval.js", "remote_url": "https://raw.githubusercontent.com/6dylan6/jdpro/refs/heads/main/jd_AutoEval.js"},
    {"local_path": "jingdong/jdCookie.js", "remote_url": "https://raw.githubusercontent.com/6dylan6/jdpro/refs/heads/main/jdCookie.js"},
    {"local_path": "jingdong/function/dylano.js", "remote_url": "https://raw.githubusercontent.com/6dylan6/jdpro/refs/heads/main/function/dylano.js"},
    {"local_path": "jingdong/function/dylanx.js", "remote_url": "https://raw.githubusercontent.com/6dylan6/jdpro/refs/heads/main/function/dylanx.js"},
    {"local_path": "jingdong/USER_AGENTS.js", "remote_url": "https://raw.githubusercontent.com/6dylan6/jdpro/refs/heads/main/USER_AGENTS.js"},
    {"local_path": "follow.py", "remote_url": "https://raw.githubusercontent.com/AKA-Cigma/QLscripts/refs/heads/main/follow.py"}
]


def main():
    updated = False
    for item in files_to_update:
        try:
            if item['remote_url'].startswith('https://github.com') and '/tree/' in item['remote_url']:
                if update_folder(item['local_path'], item['remote_url']):
                    updated = True
            else:
                if check_and_update_file(item['local_path'], item['remote_url']):
                    updated = True
        except Exception as e:
            print(f"âŒ å¤„ç† {item['local_path']} æ—¶å‡ºé”™: {str(e)}")
    
    # è®¾ç½® GitHub Actions è¾“å‡º
    set_output('files_updated', str(updated).lower())
    return updated

if __name__ == "__main__":
    main()